<!DOCTYPE html>
<html>
<title>Websocket example</title>
<script>
  //var socket = new WebSocket("ws://" + document.domain + ':' + location.port, "example-protocol");

  function update(msg) {
    document.getElementById("num").innerHTML = msg;
  }
  function update2(msg) {
    document.getElementById("num2").innerHTML = msg;
  }


 function ChrestWs(addr) {
    this.addr = addr;
    this.protocol = "chrest-pubsub";
    this.channels = [];
    this.connected = false;
    this.socket = new WebSocket(this.addr, this.protocol);
    console.log("socket", this.socket);
    var $this = this;
    this.connectedcb = [];

    this.Subscribe = function (channel, cb) {
      
      if (cb != null) {
        $this.channels.push({
          channel: channel,
          cb: cb
        });
      }
      
    };

    this.Publish = function (channel, obj) {
      try {
        var data = JSON.stringify(obj);

        var wsCMD = {
          channel: channel,
          cmd: 'publish',
          data: data
        };
        var cmd = JSON.stringify(wsCMD);

        if (($this.connected == true) && ($this.socket != null)) {
          $this.socket.send(cmd);
        } else {

          throw new Error("Cannot publish to " + channel + " websocket not connected");
        }

      } catch (error) {
        console.error(error);
      }

    };
    $this.Connected = function (cb) {
      console.log(cb);
      if (cb != null) {
        $this.connectedcb.push(cb);
      }
    };


    this.socket.onopen = function () {
      console.log("socket open%");
      $this.connected = true;
      update("open");
      for (index = 0; index < $this.connectedcb.length; ++index) {
        var cb = $this.connectedcb[index];
        cb($this);
      }
    }
    this.socket.onclose = function () {
      $this.connected = false;
      console.log("socket close");
      update("closed");
    }
    this.socket.onmessage = function (msg) {

      console.log("socket message &: " + JSON.stringify(msg));
      console.log(msg);
      //update(msg.data);
      try {
        var wsCMD = JSON.parse(msg.data);
        var index;

        for (index = 0; index < $this.channels.length; ++index) {
          var channel = $this.channels[index];
          if (wsCMD.channel == channel.channel) {
            var data = JSON.parse(wsCMD.data);
            channel.cb($this, data, wsCMD);
          }
        }

      } catch (error) {
        console.error(error);
      }
    };
  } //end function

  var con = new ChrestWs("ws://" + document.domain + ':' + location.port);


  con.Subscribe("test", function ($this, data, cmd) {
    update(cmd.data);
    console.log("Test cb1", data, " ", cmd);
  });

  con.Subscribe("data", function ($this, data, cmd) {
    update2(cmd.data);
    console.log("#&&&data cb1", data, " ", cmd);
  });

  con.Subscribe("test", function ($this, data, cmd) {
    console.log("Test cb2", data, " ", cmd);
  });


</script>

<body>
  <p id="num"></p>

  <p id="num2"></p>
</body>

</html>